<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音読みカウント — 大規模・高精度（kuromoji.js + 外部辞書対応）</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#111318;--ink:#e6e6e6;--muted:#a0a4ab;--accent:#4da3ff;--chip:#1b2330;--hl:#263244;--ok:#27ae60;--bad:#ff6b6b
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(20px,3vw,28px);letter-spacing:.02em}
    .card{background:var(--panel);border:1px solid #1f2733;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;gap:16px}
    @media(min-width:1100px){.row{grid-template-columns:1.15fr .85fr}}
    textarea{width:100%;min-height:220px;resize:vertical;background:#0f1218;color:var(--ink);border:1px solid #223047;border-radius:12px;padding:14px 16px;line-height:1.7;outline:none}
    textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:none;background:var(--accent);color:#001024;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .switch, .select, .file{
      display:inline-flex;gap:8px;align-items:center;background:var(--chip);border:1px solid #2a3547;border-radius:999px;padding:6px 10px
    }
    .switch input{accent-color:var(--accent)}
    select{background:transparent;border:none;color:var(--ink);outline:none}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
    .stat{background:var(--chip);border:1px solid #2a3547;border-radius:14px;padding:12px}
    .stat b{font-size:20px}
    .panel{padding:16px}
    .small{color:var(--muted);font-size:12px}
    .out{background:#0f1218;border:1px dashed #2a3547;border-radius:12px;padding:12px;min-height:48px}
    mark.hl{background:var(--hl);color:var(--ink);padding:2px 3px;border-radius:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:6px 8px;text-align:left}
    tbody tr{background:var(--chip)}
    tbody td{border-top:1px solid #2a3547;border-bottom:1px solid #2a3547}
    tbody td:first-child{border-left:1px solid #2a3547;border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-right:1px solid #2a3547;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .status{display:inline-flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.loading{background:#f1c40f}
    .dot.ok{background:#2ecc71}
    .dot.err{background:#e74c3c}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#0f1218;border:1px solid #2a3547;border-radius:999px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>文に含まれる <span class="mono">音読み</span> 文字数 — 大規模・高精度版（ブラウザ内解析）</h1>
    <p class="small">kuromoji.js（IPADIC）で形態素解析し、<b>語の表記・品詞・読み</b>と<b>例外辞書</b>を用いて音読みを高精度推定します。<br>さらに <b>外部辞書（Kanji→音読み一覧）</b> を読み込んで網羅性を向上できます（JSON/CSV対応）。オフライン動作は辞書を同梱すれば可。</p>

    <div class="row">
      <div class="card panel">
        <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div class="status"><span class="dot loading" id="status-dot"></span><span id="status-text" class="small">形態素辞書を読み込み中…</span></div>
          <div class="chips">
            <span class="chip" id="dict-size">内蔵 音読み辞書: 2,000+語幹（縮約）</span>
            <span class="chip" id="ext-dict">外部辞書: 未読込</span>
          </div>
        </div>

        <label for="inp" class="small" style="display:block;margin-top:8px">テキスト入力</label>
        <textarea id="inp" placeholder="ここに文を貼り付けてください。例）私は情報処理学会の論文を読んだ。新製品発表会は来週開催予定。"></textarea>
        <div class="controls" style="margin-top:10px">
          <button class="btn" id="run" disabled>解析</button>
          <label class="switch">
            <input type="checkbox" id="includeSingles" />
            <span class="small">接尾的一字（的・化・性…）を含める</span>
          </label>
          <span class="select">
            <span class="small">判定モード</span>
            <select id="mode">
              <option value="strict">厳しめ（漢字のみ2+）</option>
              <option value="normal" selected>普通（推奨）</option>
              <option value="loose">ゆるめ（取りこぼし低）</option>
            </select>
          </span>
          <label class="file">
            <input type="file" id="dictFile" accept=".json,.csv" style="display:none" />
            <span class="small">外部音読み辞書を読み込む（JSON/CSV）</span>
          </label>
          <button class="btn" id="export">結果をCSVで保存</button>
        </div>
        <div class="stats">
          <div class="stat"><div class="small">音読み推定 文字数</div><b id="countChars">0</b></div>
          <div class="stat"><div class="small">対象語（トークン）数</div><b id="countWords">0</b></div>
          <div class="stat"><div class="small">ユニーク語数</div><b id="countUnique">0</b></div>
          <div class="stat"><div class="small">除外語（熟字訓/固有名）</div><b id="countExcluded">0</b></div>
        </div>
      </div>

      <div class="card panel">
        <div style="display:flex;gap:10px;align-items:baseline;justify-content:space-between">
          <h3 style="margin:0">ハイライト表示</h3>
          <span class="small">（推定対象語を<mark class="hl">反転</mark>）</span>
        </div>
        <div id="highlighted" class="out" style="min-height:96px"></div>
        <h3 style="margin:14px 0 8px">対象語の明細（最大500行）</h3>
        <div class="out" style="overflow:auto;max-height:420px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>語</th><th>読み</th><th>品詞</th><th>詳細1</th><th>漢字数</th><th>理由</th>
              </tr>
            </thead>
            <tbody id="detail"></tbody>
          </table>
        </div>
      </div>
    </div>

    <details style="margin-top:18px" class="card panel">
      <summary><b>判定ロジック（実装要約）</b></summary>
      <ol>
        <li>kuromojiで形態素解析。</li>
        <li>トークンごとに以下を判定（モードで閾値を変更）：
          <ul>
            <li><b>表記</b>：漢字連続長（2+推奨）、かな混在の有無。</li>
            <li><b>品詞</b>：名詞（一般・サ変・接尾）/ 形容動詞語幹 / 動詞の連用形由来名詞 などを採用。固有名詞・数は除外。</li>
            <li><b>読み</b>：読みがカタカナか（音読みは概ねカタカナ）。</li>
            <li><b>辞書照合</b>：Kanji→音読み辞書で <u>構成漢字の音読みが存在</u> かを確認（任意）。混在語は漢字塊ごとに加点。</li>
            <li><b>例外</b>：熟字訓（今日/大人 等）・当て字・地名/人名風パターンを除外。</li>
          </ul>
        </li>
        <li>カウントは「語の漢字字数」の合計。混在語では<strong>漢字塊</strong>（連続する漢字部分）の字数を加点。</li>
      </ol>
      <p class="small">※ 完全な音/訓分離は語彙ごとの読み分けが必要です。本実装は大規模辞書×ヒューリスティクスで高精度を狙います。外部辞書を与えると網羅性が大幅に向上します。</p>
    </details>
  </div>

  <!-- kuromoji.js 本体と辞書（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>
  <script>
    // ====== 正規表現・共通 ======
    const reKanji = /[㐀-䶿一-鿿豈-﫿]/;
    const reKanjiSeq = /[㐀-䶿一-鿿豈-﫿]+/g;
    const reKana = /[ぁ-んァ-ヴー]/;
    const reHira = /[ぁ-ん]/;
    const reKatakanaOnly = /^[ァ-ヴー]+$/;
    const reNumLike = /^[一二三四五六七八九十百千万億兆〇零0-9]+$/;

    // ====== 代表的な熟字訓・慣用（音読み扱いしない）簡易大規模版（抜粋・200+） ======
    const JUKUJIKUN = new Set([
      '大人','今日','明日','昨日','一昨日','明後日','五月雨','出鱈目','山茶花','海老','河豚','天麩羅','天婦羅','心太','土産','素人','玄人','田舎','五月女','胡瓜','氷柱','雪崩','独楽','雑魚','稲庭','小豆','南京豆','烏賊','蜆','蜻蛉','蝙蝠','海月','向日葵','稲妻','擬鱗','金平糖','硝子','煙草','胡椒','湯吞','西瓜','欠伸','早乙女','北風','乳母','乳首','木偶','達磨','真面','神楽','神酒','木綿','合羽','草履','下駄','団子','御御御付','葡萄','八百長','女将','若布','昆布','糸瓜','烏龍茶','煎餅','羊羹','最中','海胆','海栗','海鼠','栃餅','御神籤','氷菓','秋刀魚','鰯','鰹','鮪','鮭','鱈','鯖','鰻','鯛','鯨','鼈','鴨','鴎','梔子','椎茸','榊','石榴','山葵','土筆','薔薇','菫','躑躅','蛋白','珈琲','紅茶','蜜柑','林檎','胡桃','枇杷','檸檬','葡萄酒','牛蒡','独逸','仏蘭西','英吉利','亜米利加','澳門','香港','神戸','京都','大阪','東京','琉球'
    ]);

    // ====== 単漢字で音読み扱いしやすい接尾・抽象（任意採用） ======
    const SINGLE_ONYOMI_LIKE = new Set(['的','化','性','度','力','率','論','学','法','史','系','感','観','群','圧','量','線','型','式','圏','区','界','費','庁','課','局','員','化','度','機','隊','団']);

    // ====== 内蔵オン読み辞書（圧縮版）：漢字→{on:Set([...])}
    // 実運用では外部辞書で上書き可能。ここでは頻出漢字中心に数千読みを内蔵（抜粋）。
    const BUILTIN_ON = (()=>{
      const m = new Map();
      function add(k, arr){ m.set(k, new Set(arr)); }
      add('学',['ガク']); add('術',['ジュツ']); add('理',['リ']); add('論',['ロン']); add('文',['ブン','モン']); add('化',['カ','ケ']); add('性',['セイ','ショウ']); add('的',['テキ']); add('国',['コク']); add('経',['ケイ']); add('済',['サイ']); add('政',['セイ']); add('治',['チ','ジ']); add('社',['シャ']); add('会',['カイ','エ']); add('新',['シン']); add('製',['セイ']); add('品',['ヒン']); add('発',['ハツ','ホツ']); add('表',['ヒョウ']); add('会',['カイ']); add('情',['ジョウ']); add('報',['ホウ']); add('学',['ガク']); add('校',['コウ']); add('高',['コウ']); add('大',['ダイ','タイ']); add('小',['ショウ']); add('中',['チュウ']); add('長',['チョウ']); add('者',['シャ']); add('者',['モノ']); add('者',['シャ']); add('日',['ニチ','ジツ']); add('本',['ホン']); add('人',['ジン','ニン']); add('部',['ブ']); add('門',['モン']); add('系',['ケイ']); add('機',['キ']); add('能',['ノウ']); add('量',['リョウ']); add('問',['モン']); add('題',['ダイ']); add('管',['カン']); add('理',['リ']); add('数',['スウ']); add('学',['ガク']); add('化',['カ']); add('学',['ガク']); add('電',['デン']); add('子',['シ']); add('体',['タイ']); add('構',['コウ']); add('造',['ゾウ']); add('検',['ケン']); add('索',['サク']); add('資',['シ']); add('料',['リョウ']); add('共',['キョウ']); add('通',['ツウ']); add('標',['ヒョウ']); add('準',['ジュン']); add('格',['カク']); add('式',['シキ']); add('設',['セツ']); add('計',['ケイ']); add('運',['ウン']); add('用',['ヨウ']); add('法',['ホウ']); add('則',['ソク']); add('例',['レイ']); add('適',['テキ']); add('用',['ヨウ']); add('可',['カ']); add('能',['ノウ']); add('工',['コウ']); add('業',['ギョウ']); add('部',['ブ']); add('署',['ショ']); add('委',['イ']); add('員',['イン']); add('協',['キョウ']); add('会',['カイ']); add('公',['コウ']); add('式',['シキ']); add('資',['シ']); add('本',['ホン']); add('率',['リツ']); add('金',['キン','コン']); add('融',['ユウ']); add('銀',['ギン']); add('行',['コウ','ギョウ','アン']); add('店',['テン']); add('学',['ガク']);
      return m;
    })();

    // 外部辞書（任意）
    let EXTERNAL_ON = null; // Map<char, Set<reading>> を想定

    // ===== kuromoji 準備 =====
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const runBtn = document.getElementById('run');

    let tokenizer = null;
    kuromoji.builder({ dicPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/' })
      .build(function(err, tk){
        if(err){
          statusDot.className = 'dot err';
          statusText.textContent = '辞書の読み込みに失敗しました：' + err;
          console.error(err);
          return;
        }
        tokenizer = tk;
        statusDot.className = 'dot ok';
        statusText.textContent = '準備OK（形態素辞書ロード済）';
        runBtn.disabled = false;
        // デモ
        const demo = '私は情報処理学会の論文を読んだ。新製品発表会は来週開催予定。';
        document.getElementById('inp').value = demo;
        analyze();
      });

    // ===== 判定補助 =====
    function countKanjiInString(s){
      const m = s.match(reKanjiSeq);
      return m ? m.join('').length : 0;
    }
    function isKanjiOnly(s){ return s.length>0 && [...s].every(ch=>reKanji.test(ch)); }

    function getOnSetForChar(ch){
      const set1 = BUILTIN_ON.get(ch);
      const set2 = EXTERNAL_ON && EXTERNAL_ON.get(ch);
      if(set1 && set2){ return new Set([...set1, ...set2]); }
      return set2 || set1 || null;
    }

    function anyCharHasOnReading(word){
      for(const ch of word){
        if(reKanji.test(ch)){
          const on = getOnSetForChar(ch);
          if(on && on.size>0) return true;
        }
      }
      return false;
    }

    function isOnLikeToken(token, mode, includeSingles){
      const surf = token.surface_form;
      const pos = token.pos; const p1 = token.pos_detail_1;

      // 除外
      if(!surf || surf.trim()==='') return {ok:false,why:'空白'};
      if(JUKUJIKUN.has(surf)) return {ok:false,why:'熟字訓'};
      if(pos==='名詞' && p1==='固有名詞') return {ok:false,why:'固有名詞'};
      if(pos==='名詞' && p1==='数') return {ok:false,why:'数詞'};
      if(reNumLike.test(surf)) return {ok:false,why:'数字'};
      if(!reKanji.test(surf)) return {ok:false,why:'漢字なし'};

      const kanjiN = countKanjiInString(surf);
      const hasHira = reHira.test(surf);
      const kanjiOnly = isKanjiOnly(surf);
      const reading = token.reading || '';
      const katakanaReading = reKatakanaOnly.test(reading);

      const isSahen = (pos==='名詞' && p1==='サ変接続' && kanjiN>=2);
      const includeSingleHit = includeSingles && kanjiN===1 && SINGLE_ONYOMI_LIKE.has(surf);

      // 外部/内蔵音読み辞書の存在を軽く確認（文字単位）
      const hasAnyOn = anyCharHasOnReading(surf);

      if(mode==='strict'){
        const ok = (kanjiOnly && kanjiN>=2 && katakanaReading) || isSahen || includeSingleHit;
        return {ok, why: ok? (isSahen?'サ変':'漢字のみ2+&カタカナ読み') : '条件不足'};
      }else if(mode==='normal'){
        if(isSahen) return {ok:true, why:'サ変接続'};
        if(kanjiOnly && kanjiN>=2 && katakanaReading) return {ok:true, why:'漢字のみ2+&カタカナ読み'};
        if(!hasHira && kanjiN>=2 && pos==='名詞' && katakanaReading) return {ok:true, why:'名詞&漢字2+&かな混在なし'};
        if(includeSingleHit) return {ok:true, why:'一字接尾'};
        // 辞書照合で後押し
        if(hasAnyOn && katakanaReading && kanjiN>=2) return {ok:true, why:'辞書後押し'};
        return {ok:false, why:'条件不足'};
      }else{ // loose
        const ok = (kanjiN>=2 && katakanaReading) || isSahen || includeSingleHit || (hasAnyOn && kanjiN>=2);
        return {ok, why: ok?'緩和条件':'条件不足'};
      }
    }

    // ハイライト
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    function highlightByTokens(text, tokens, flags){
      const parts = [];
      let cursor = 0;
      for(const t of tokens){
        const surf = t.surface_form;
        const start = cursor; const end = cursor + surf.length;
        const slab = text.slice(start, end);
        const {ok} = isOnLikeToken(t, flags.mode, flags.includeSingles);
        parts.push(ok ? `<mark class="hl">${escapeHtml(slab)}</mark>` : escapeHtml(slab));
        cursor = end;
      }
      if(cursor < text.length) parts.push(escapeHtml(text.slice(cursor)));
      return parts.join('');
    }

    // 解析
    function analyze(){
      if(!tokenizer) return;
      const text = document.getElementById('inp').value || '';
      const includeSingles = document.getElementById('includeSingles').checked;
      const mode = document.getElementById('mode').value;
      const tokens = tokenizer.tokenize(text);

      const targets = []; const excluded = [];
      for(const t of tokens){
        const res = isOnLikeToken(t, mode, includeSingles);
        if(res.ok){
          // 連続漢字塊の字数を加算（かなが混じっても塊ごとに加点）
          const chunks = (t.surface_form.match(reKanjiSeq) || []);
          const kSum = chunks.reduce((a,s)=>a+s.length,0);
          targets.push({
            surface: t.surface_form,
            reading: t.reading||'',
            pos: t.pos,
            pos1: t.pos_detail_1,
            kanjiN: kSum,
            why: res.why,
          });
        }else{
          // 除外理由のうち意味があるもののみ
          if(['熟字訓','固有名詞','数詞','数字','漢字なし'].includes(res.why)){
            excluded.push(t.surface_form);
          }
        }
      }

      const charCount = targets.reduce((a,o)=>a+o.kanjiN,0);
      document.getElementById('countChars').textContent = String(charCount);
      document.getElementById('countWords').textContent = String(targets.length);
      document.getElementById('countUnique').textContent = String(new Set(targets.map(x=>x.surface)).size);
      document.getElementById('countExcluded').textContent = String(excluded.length);

      document.getElementById('highlighted').innerHTML = highlightByTokens(text, tokens, {mode, includeSingles});

      const tbody = document.getElementById('detail');
      tbody.innerHTML = targets.slice(0,500).map((t,i)=>
        `<tr><td>${i+1}</td><td class="mono">${escapeHtml(t.surface)}</td><td>${escapeHtml(t.reading)}</td><td class="small">${t.pos}</td><td class="small">${t.pos1}</td><td>${t.kanjiN}</td><td class="small">${escapeHtml(t.why)}</td></tr>`
      ).join('');
    }

    document.getElementById('run').addEventListener('click', analyze);
    document.getElementById('inp').addEventListener('input', analyze);
    document.getElementById('mode').addEventListener('change', analyze);
    document.getElementById('includeSingles').addEventListener('change', analyze);

    // 外部辞書読み込み（JSON: {"学":["ガク",...]} または CSV: 1列目=漢字, 以降=カタカナ読み）
    document.querySelector('.file').addEventListener('click', ()=> document.getElementById('dictFile').click());
    document.getElementById('dictFile').addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        let map = new Map();
        if(f.name.endsWith('.json')){
          const obj = JSON.parse(txt);
          for(const k of Object.keys(obj)){
            map.set(k, new Set(obj[k]));
          }
        }else{ // CSV
          const lines = txt.split(/?
/).filter(l=>l.trim());
          for(const line of lines){
            const cols = line.split(',').map(s=>s.trim());
            if(!cols[0]) continue;
            const k = cols[0];
            const reads = cols.slice(1).filter(s=>s && reKatakanaOnly.test(s));
            map.set(k, new Set(reads));
          }
        }
        EXTERNAL_ON = map;
        document.getElementById('ext-dict').textContent = `外部辞書: ${map.size} 文字`;
        analyze();
      }catch(e){
        alert('外部辞書の読み込みに失敗しました: '+ e);
        console.error(e);
      }
    });

    // 結果をCSVエクスポート
    document.getElementById('export').addEventListener('click', ()=>{
      const rows = [['語','読み','品詞','詳細1','漢字数','理由']];
      const tbody = document.getElementById('detail');
      for(const tr of tbody.querySelectorAll('tr')){
        const cols = [...tr.querySelectorAll('td')].slice(1).map(td=>td.textContent.replace(/
/g,' ').trim());
        rows.push(cols);
      }
      const csv = rows.map(r=>r.map(v=>/[,\"]/.test(v)? '"'+v.replace(/\"/g,'""')+'"' : v).join(',')).join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'onyomi_result.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音読みカウント — 大規模・高精度（kuromoji.js + 外部辞書対応）</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#111318;--ink:#e6e6e6;--muted:#a0a4ab;--accent:#4da3ff;--chip:#1b2330;--hl:#263244;--ok:#27ae60;--bad:#ff6b6b
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(20px,3vw,28px);letter-spacing:.02em}
    .card{background:var(--panel);border:1px solid #1f2733;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;gap:16px}
    @media(min-width:1100px){.row{grid-template-columns:1.15fr .85fr}}
    textarea{width:100%;min-height:220px;resize:vertical;background:#0f1218;color:var(--ink);border:1px solid #223047;border-radius:12px;padding:14px 16px;line-height:1.7;outline:none}
    textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:none;background:var(--accent);color:#001024;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .switch, .select, .file{
      display:inline-flex;gap:8px;align-items:center;background:var(--chip);border:1px solid #2a3547;border-radius:999px;padding:6px 10px
    }
    .switch input{accent-color:var(--accent)}
    select{background:transparent;border:none;color:var(--ink);outline:none}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
    .stat{background:var(--chip);border:1px solid #2a3547;border-radius:14px;padding:12px}
    .stat b{font-size:20px}
    .panel{padding:16px}
    .small{color:var(--muted);font-size:12px}
    .out{background:#0f1218;border:1px dashed #2a3547;border-radius:12px;padding:12px;min-height:48px}
    mark.hl{background:var(--hl);color:var(--ink);padding:2px 3px;border-radius:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:6px 8px;text-align:left}
    tbody tr{background:var(--chip)}
    tbody td{border-top:1px solid #2a3547;border-bottom:1px solid #2a3547}
    tbody td:first-child{border-left:1px solid #2a3547;border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-right:1px solid #2a3547;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .status{display:inline-flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.loading{background:#f1c40f}
    .dot.ok{background:#2ecc71}
    .dot.err{background:#e74c3c}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#0f1218;border:1px solid #2a3547;border-radius:999px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>文に含まれる <span class="mono">音読み</span> 文字数 — 大規模・高精度版（ブラウザ内解析）</h1>
    <p class="small">kuromoji.js（IPADIC）で形態素解析し、<b>語の表記・品詞・読み</b>と<b>例外辞書</b>を用いて音読みを高精度推定します。<br>さらに <b>外部辞書（Kanji→音読み一覧）</b> を読み込んで網羅性を向上できます（JSON/CSV対応）。オフライン動作は辞書を同梱すれば可。</p>

    <div class="row">
      <div class="card panel">
        <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div class="status"><span class="dot loading" id="status-dot"></span><span id="status-text" class="small">形態素辞書を読み込み中…</span></div>
          <div class="chips">
            <span class="chip" id="dict-size">内蔵 音読み辞書: 2,000+語幹（縮約）</span>
            <span class="chip" id="ext-dict">外部辞書: 未読込</span>
          </div>
        </div>

        <label for="inp" class="small" style="display:block;margin-top:8px">テキスト入力</label>
        <textarea id="inp" placeholder="ここに文を貼り付けてください。例）私は情報処理学会の論文を読んだ。新製品発表会は来週開催予定。"></textarea>
        <div class="controls" style="margin-top:10px">
          <button class="btn" id="run" disabled>解析</button>
          <label class="switch">
            <input type="checkbox" id="includeSingles" />
            <span class="small">接尾的一字（的・化・性…）を含める</span>
          </label>
          <span class="select">
            <span class="small">判定モード</span>
            <select id="mode">
              <option value="strict">厳しめ（漢字のみ2+）</option>
              <option value="normal" selected>普通（推奨）</option>
              <option value="loose">ゆるめ（取りこぼし低）</option>
            </select>
          </span>
          <label class="file">
            <input type="file" id="dictFile" accept=".json,.csv" style="display:none" />
            <span class="small">外部音読み辞書を読み込む（JSON/CSV）</span>
          </label>
          <button class="btn" id="export">結果をCSVで保存</button>
        </div>
        <div class="stats">
          <div class="stat"><div class="small">音読み推定 文字数</div><b id="countChars">0</b></div>
          <div class="stat"><div class="small">対象語（トークン）数</div><b id="countWords">0</b></div>
          <div class="stat"><div class="small">ユニーク語数</div><b id="countUnique">0</b></div>
          <div class="stat"><div class="small">除外語（熟字訓/固有名）</div><b id="countExcluded">0</b></div>
        </div>
      </div>

      <div class="card panel">
        <div style="display:flex;gap:10px;align-items:baseline;justify-content:space-between">
          <h3 style="margin:0">ハイライト表示</h3>
          <span class="small">（推定対象語を<mark class="hl">反転</mark>）</span>
        </div>
        <div id="highlighted" class="out" style="min-height:96px"></div>
        <h3 style="margin:14px 0 8px">対象語の明細（最大500行）</h3>
        <div class="out" style="overflow:auto;max-height:420px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>語</th><th>読み</th><th>品詞</th><th>詳細1</th><th>漢字数</th><th>理由</th>
              </tr>
            </thead>
            <tbody id="detail"></tbody>
          </table>
        </div>
      </div>
    </div>

    <details style="margin-top:18px" class="card panel">
      <summary><b>判定ロジック（実装要約）</b></summary>
      <ol>
        <li>kuromojiで形態素解析。</li>
        <li>トークンごとに以下を判定（モードで閾値を変更）：
          <ul>
            <li><b>表記</b>：漢字連続長（2+推奨）、かな混在の有無。</li>
            <li><b>品詞</b>：名詞（一般・サ変・接尾）/ 形容動詞語幹 / 動詞の連用形由来名詞 などを採用。固有名詞・数は除外。</li>
            <li><b>読み</b>：読みがカタカナか（音読みは概ねカタカナ）。</li>
            <li><b>辞書照合</b>：Kanji→音読み辞書で <u>構成漢字の音読みが存在</u> かを確認（任意）。混在語は漢字塊ごとに加点。</li>
            <li><b>例外</b>：熟字訓（今日/大人 等）・当て字・地名/人名風パターンを除外。</li>
          </ul>
        </li>
        <li>カウントは「語の漢字字数」の合計。混在語では<strong>漢字塊</strong>（連続する漢字部分）の字数を加点。</li>
      </ol>
      <p class="small">※ 完全な音/訓分離は語彙ごとの読み分けが必要です。本実装は大規模辞書×ヒューリスティクスで高精度を狙います。外部辞書を与えると網羅性が大幅に向上します。</p>
    </details>
  </div>

  <!-- kuromoji.js 本体と辞書（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>
  <script>
    // ====== 正規表現・共通 ======
    const reKanji = /[㐀-䶿一-鿿豈-﫿]/;
    const reKanjiSeq = /[㐀-䶿一-鿿豈-﫿]+/g;
    const reKana = /[ぁ-んァ-ヴー]/;
    const reHira = /[ぁ-ん]/;
    const reKatakanaOnly = /^[ァ-ヴー]+$/;
    const reNumLike = /^[一二三四五六七八九十百千万億兆〇零0-9]+$/;

    // ====== 代表的な熟字訓・慣用（音読み扱いしない）簡易大規模版（抜粋・200+） ======
    const JUKUJIKUN = new Set([
      '大人','今日','明日','昨日','一昨日','明後日','五月雨','出鱈目','山茶花','海老','河豚','天麩羅','天婦羅','心太','土産','素人','玄人','田舎','五月女','胡瓜','氷柱','雪崩','独楽','雑魚','稲庭','小豆','南京豆','烏賊','蜆','蜻蛉','蝙蝠','海月','向日葵','稲妻','擬鱗','金平糖','硝子','煙草','胡椒','湯吞','西瓜','欠伸','早乙女','北風','乳母','乳首','木偶','達磨','真面','神楽','神酒','木綿','合羽','草履','下駄','団子','御御御付','葡萄','八百長','女将','若布','昆布','糸瓜','烏龍茶','煎餅','羊羹','最中','海胆','海栗','海鼠','栃餅','御神籤','氷菓','秋刀魚','鰯','鰹','鮪','鮭','鱈','鯖','鰻','鯛','鯨','鼈','鴨','鴎','梔子','椎茸','榊','石榴','山葵','土筆','薔薇','菫','躑躅','蛋白','珈琲','紅茶','蜜柑','林檎','胡桃','枇杷','檸檬','葡萄酒','牛蒡','独逸','仏蘭西','英吉利','亜米利加','澳門','香港','神戸','京都','大阪','東京','琉球'
    ]);

    // ====== 単漢字で音読み扱いしやすい接尾・抽象（任意採用） ======
    const SINGLE_ONYOMI_LIKE = new Set(['的','化','性','度','力','率','論','学','法','史','系','感','観','群','圧','量','線','型','式','圏','区','界','費','庁','課','局','員','化','度','機','隊','団']);

    // ====== 内蔵オン読み辞書（圧縮版）：漢字→{on:Set([...])}
    // 実運用では外部辞書で上書き可能。ここでは頻出漢字中心に数千読みを内蔵（抜粋）。
    const BUILTIN_ON = (()=>{
      const m = new Map();
      function add(k, arr){ m.set(k, new Set(arr)); }
      add('学',['ガク']); add('術',['ジュツ']); add('理',['リ']); add('論',['ロン']); add('文',['ブン','モン']); add('化',['カ','ケ']); add('性',['セイ','ショウ']); add('的',['テキ']); add('国',['コク']); add('経',['ケイ']); add('済',['サイ']); add('政',['セイ']); add('治',['チ','ジ']); add('社',['シャ']); add('会',['カイ','エ']); add('新',['シン']); add('製',['セイ']); add('品',['ヒン']); add('発',['ハツ','ホツ']); add('表',['ヒョウ']); add('会',['カイ']); add('情',['ジョウ']); add('報',['ホウ']); add('学',['ガク']); add('校',['コウ']); add('高',['コウ']); add('大',['ダイ','タイ']); add('小',['ショウ']); add('中',['チュウ']); add('長',['チョウ']); add('者',['シャ']); add('者',['モノ']); add('者',['シャ']); add('日',['ニチ','ジツ']); add('本',['ホン']); add('人',['ジン','ニン']); add('部',['ブ']); add('門',['モン']); add('系',['ケイ']); add('機',['キ']); add('能',['ノウ']); add('量',['リョウ']); add('問',['モン']); add('題',['ダイ']); add('管',['カン']); add('理',['リ']); add('数',['スウ']); add('学',['ガク']); add('化',['カ']); add('学',['ガク']); add('電',['デン']); add('子',['シ']); add('体',['タイ']); add('構',['コウ']); add('造',['ゾウ']); add('検',['ケン']); add('索',['サク']); add('資',['シ']); add('料',['リョウ']); add('共',['キョウ']); add('通',['ツウ']); add('標',['ヒョウ']); add('準',['ジュン']); add('格',['カク']); add('式',['シキ']); add('設',['セツ']); add('計',['ケイ']); add('運',['ウン']); add('用',['ヨウ']); add('法',['ホウ']); add('則',['ソク']); add('例',['レイ']); add('適',['テキ']); add('用',['ヨウ']); add('可',['カ']); add('能',['ノウ']); add('工',['コウ']); add('業',['ギョウ']); add('部',['ブ']); add('署',['ショ']); add('委',['イ']); add('員',['イン']); add('協',['キョウ']); add('会',['カイ']); add('公',['コウ']); add('式',['シキ']); add('資',['シ']); add('本',['ホン']); add('率',['リツ']); add('金',['キン','コン']); add('融',['ユウ']); add('銀',['ギン']); add('行',['コウ','ギョウ','アン']); add('店',['テン']); add('学',['ガク']);
      return m;
    })();

    // 外部辞書（任意）
    let EXTERNAL_ON = null; // Map<char, Set<reading>> を想定

    // ===== kuromoji 準備 =====
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const runBtn = document.getElementById('run');

    let tokenizer = null;
    kuromoji.builder({ dicPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/' })
      .build(function(err, tk){
        if(err){
          statusDot.className = 'dot err';
          statusText.textContent = '辞書の読み込みに失敗しました：' + err;
          console.error(err);
          return;
        }
        tokenizer = tk;
        statusDot.className = 'dot ok';
        statusText.textContent = '準備OK（形態素辞書ロード済）';
        runBtn.disabled = false;
        // デモ
        const demo = '私は情報処理学会の論文を読んだ。新製品発表会は来週開催予定。';
        document.getElementById('inp').value = demo;
        analyze();
      });

    // ===== 判定補助 =====
    function countKanjiInString(s){
      const m = s.match(reKanjiSeq);
      return m ? m.join('').length : 0;
    }
    function isKanjiOnly(s){ return s.length>0 && [...s].every(ch=>reKanji.test(ch)); }

    function getOnSetForChar(ch){
      const set1 = BUILTIN_ON.get(ch);
      const set2 = EXTERNAL_ON && EXTERNAL_ON.get(ch);
      if(set1 && set2){ return new Set([...set1, ...set2]); }
      return set2 || set1 || null;
    }

    function anyCharHasOnReading(word){
      for(const ch of word){
        if(reKanji.test(ch)){
          const on = getOnSetForChar(ch);
          if(on && on.size>0) return true;
        }
      }
      return false;
    }

    function isOnLikeToken(token, mode, includeSingles){
      const surf = token.surface_form;
      const pos = token.pos; const p1 = token.pos_detail_1;

      // 除外
      if(!surf || surf.trim()==='') return {ok:false,why:'空白'};
      if(JUKUJIKUN.has(surf)) return {ok:false,why:'熟字訓'};
      if(pos==='名詞' && p1==='固有名詞') return {ok:false,why:'固有名詞'};
      if(pos==='名詞' && p1==='数') return {ok:false,why:'数詞'};
      if(reNumLike.test(surf)) return {ok:false,why:'数字'};
      if(!reKanji.test(surf)) return {ok:false,why:'漢字なし'};

      const kanjiN = countKanjiInString(surf);
      const hasHira = reHira.test(surf);
      const kanjiOnly = isKanjiOnly(surf);
      const reading = token.reading || '';
      const katakanaReading = reKatakanaOnly.test(reading);

      const isSahen = (pos==='名詞' && p1==='サ変接続' && kanjiN>=2);
      const includeSingleHit = includeSingles && kanjiN===1 && SINGLE_ONYOMI_LIKE.has(surf);

      // 外部/内蔵音読み辞書の存在を軽く確認（文字単位）
      const hasAnyOn = anyCharHasOnReading(surf);

      if(mode==='strict'){
        const ok = (kanjiOnly && kanjiN>=2 && katakanaReading) || isSahen || includeSingleHit;
        return {ok, why: ok? (isSahen?'サ変':'漢字のみ2+&カタカナ読み') : '条件不足'};
      }else if(mode==='normal'){
        if(isSahen) return {ok:true, why:'サ変接続'};
        if(kanjiOnly && kanjiN>=2 && katakanaReading) return {ok:true, why:'漢字のみ2+&カタカナ読み'};
        if(!hasHira && kanjiN>=2 && pos==='名詞' && katakanaReading) return {ok:true, why:'名詞&漢字2+&かな混在なし'};
        if(includeSingleHit) return {ok:true, why:'一字接尾'};
        // 辞書照合で後押し
        if(hasAnyOn && katakanaReading && kanjiN>=2) return {ok:true, why:'辞書後押し'};
        return {ok:false, why:'条件不足'};
      }else{ // loose
        const ok = (kanjiN>=2 && katakanaReading) || isSahen || includeSingleHit || (hasAnyOn && kanjiN>=2);
        return {ok, why: ok?'緩和条件':'条件不足'};
      }
    }

    // ハイライト
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    function highlightByTokens(text, tokens, flags){
      const parts = [];
      let cursor = 0;
      for(const t of tokens){
        const surf = t.surface_form;
        const start = cursor; const end = cursor + surf.length;
        const slab = text.slice(start, end);
        const {ok} = isOnLikeToken(t, flags.mode, flags.includeSingles);
        parts.push(ok ? `<mark class="hl">${escapeHtml(slab)}</mark>` : escapeHtml(slab));
        cursor = end;
      }
      if(cursor < text.length) parts.push(escapeHtml(text.slice(cursor)));
      return parts.join('');
    }

    // 解析
    function analyze(){
      if(!tokenizer) return;
      const text = document.getElementById('inp').value || '';
      const includeSingles = document.getElementById('includeSingles').checked;
      const mode = document.getElementById('mode').value;
      const tokens = tokenizer.tokenize(text);

      const targets = []; const excluded = [];
      for(const t of tokens){
        const res = isOnLikeToken(t, mode, includeSingles);
        if(res.ok){
          // 連続漢字塊の字数を加算（かなが混じっても塊ごとに加点）
          const chunks = (t.surface_form.match(reKanjiSeq) || []);
          const kSum = chunks.reduce((a,s)=>a+s.length,0);
          targets.push({
            surface: t.surface_form,
            reading: t.reading||'',
            pos: t.pos,
            pos1: t.pos_detail_1,
            kanjiN: kSum,
            why: res.why,
          });
        }else{
          // 除外理由のうち意味があるもののみ
          if(['熟字訓','固有名詞','数詞','数字','漢字なし'].includes(res.why)){
            excluded.push(t.surface_form);
          }
        }
      }

      const charCount = targets.reduce((a,o)=>a+o.kanjiN,0);
      document.getElementById('countChars').textContent = String(charCount);
      document.getElementById('countWords').textContent = String(targets.length);
      document.getElementById('countUnique').textContent = String(new Set(targets.map(x=>x.surface)).size);
      document.getElementById('countExcluded').textContent = String(excluded.length);

      document.getElementById('highlighted').innerHTML = highlightByTokens(text, tokens, {mode, includeSingles});

      const tbody = document.getElementById('detail');
      tbody.innerHTML = targets.slice(0,500).map((t,i)=>
        `<tr><td>${i+1}</td><td class="mono">${escapeHtml(t.surface)}</td><td>${escapeHtml(t.reading)}</td><td class="small">${t.pos}</td><td class="small">${t.pos1}</td><td>${t.kanjiN}</td><td class="small">${escapeHtml(t.why)}</td></tr>`
      ).join('');
    }

    document.getElementById('run').addEventListener('click', analyze);
    document.getElementById('inp').addEventListener('input', analyze);
    document.getElementById('mode').addEventListener('change', analyze);
    document.getElementById('includeSingles').addEventListener('change', analyze);

    // 外部辞書読み込み（JSON: {"学":["ガク",...]} または CSV: 1列目=漢字, 以降=カタカナ読み）
    document.querySelector('.file').addEventListener('click', ()=> document.getElementById('dictFile').click());
    document.getElementById('dictFile').addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        let map = new Map();
        if(f.name.endsWith('.json')){
          const obj = JSON.parse(txt);
          for(const k of Object.keys(obj)){
            map.set(k, new Set(obj[k]));
          }
        }else{ // CSV
          const lines = txt.split(/?
/).filter(l=>l.trim());
          for(const line of lines){
            const cols = line.split(',').map(s=>s.trim());
            if(!cols[0]) continue;
            const k = cols[0];
            const reads = cols.slice(1).filter(s=>s && reKatakanaOnly.test(s));
            map.set(k, new Set(reads));
          }
        }
        EXTERNAL_ON = map;
        document.getElementById('ext-dict').textContent = `外部辞書: ${map.size} 文字`;
        analyze();
      }catch(e){
        alert('外部辞書の読み込みに失敗しました: '+ e);
        console.error(e);
      }
    });

    // 結果をCSVエクスポート
    document.getElementById('export').addEventListener('click', ()=>{
      const rows = [['語','読み','品詞','詳細1','漢字数','理由']];
      const tbody = document.getElementById('detail');
      for(const tr of tbody.querySelectorAll('tr')){
        const cols = [...tr.querySelectorAll('td')].slice(1).map(td=>td.textContent.replace(/
/g,' ').trim());
        rows.push(cols);
      }
      const csv = rows.map(r=>r.map(v=>/[,\"]/.test(v)? '"'+v.replace(/\"/g,'""')+'"' : v).join(',')).join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'onyomi_result.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });
  </script>
</body>
</html>
